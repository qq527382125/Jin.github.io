<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="JINXO">
    
    <meta name="description" content="全栈">
    
    
    
    
    
    
    <title>Tampermonkey简单脚本编写 | JINXO</title>
    <link href=”JINxo-geek.github.io“ rel=”prefetch” />

    <link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/aos.css">
<link rel="stylesheet" href="/css/style.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/aos.js"></script>
    <script src="/js/highslide/highslide-full.min.js"></script>
    <link rel="stylesheet" href="/js/highslide/highslide.css">
    <style type="text/css">
        @media (max-width: 768px) {
            body {
                background-color: #f0f0f0;
                background: url('/imgs/xsbg.gif');
                background-attachment: fixed;
            }
        }
    </style>
    
    <!--<script type="text/javascript">
      if (document.images) {
        var avatar = new Image();
        avatar.src = '/imgs/avatar.jpg'
        var previews = 'preview1.jpg,preview2.jpg,preview3.jpg,preview4.jpg'.split(',')
        var previewsPreLoad = []
        for(var i = 0; i < length; i++) {
          previewsPreLoad.push(new Image())
          previewsPreLoad[previewsPreLoad.length - 1].src = '/imgs/preview' + previews[i]
        }
      }
    </script>-->
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
<body>
    <!-- 背景轮播图功能 -->
    <section class="hidden-xs">
    <ul class="cb-slideshow">
        <li><span>天若</span></li>
        <li><span>有情</span></li>
        <li><span>天亦老</span></li>
        <li><span>我为</span></li>
        <li><span>长者</span></li>
        <li><span>续一秒</span></li>
    </ul>
</section>
    <!-- 欧尼酱功能, 谁用谁知道 -->
    
    <header class="navbar navbar-inverse" id="gal-header">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target=".bs-navbar-collapse"
                    aria-expanded="false">
                <span class="fa fa-lg fa-reorder"></span>
            </button>
            <a href="JINxo-geek.github.io">
                
                <style>
                    #gal-header .navbar-brand {
                        height: 54px;
                        line-height: 24px;
                        font-size: 28px;
                        opacity: 1;
                        background-color: rgba(0,0,0,0);
                        text-shadow: 0 0 5px #fff,0 0 10px #fff,0 0 15px #fff,0 0 20px #228DFF,0 0 35px #228DFF,0 0 40px #228DFF,0 0 50px #228DFF,0 0 75px #228DFF;
                    }
                </style>
                <!-- 这里使用文字(navbar_text or config.title) -->
                <div class="navbar-brand">JINXO</div>
                
            </a>
        </div>
        <div class="collapse navbar-collapse bs-navbar-collapse">
            <ul class="nav navbar-nav" id="menu-gal">
                
                
                <li class="">
                    <a href="/">
                        <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                
                
                <li class="">
                    <a href="/archives">
                        <i class="fa fa-archive"></i>归档
                    </a>
                </li>
                
                
                
                
                <li class="dropdown">
                    <!-- TODO 添加hover dropdown效果 -->
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false" data-hover="dropdown">
                        <i class="fa fa-list"></i>分类
                    </a>
                    <ul class="dropdown-menu">
                        
                        
                        <li>
                            <a href="/categories/习惯/">习惯</a>
                        </li>
                        
                        <li>
                            <a href="/categories/ES6/">ES6</a>
                        </li>
                        
                        <li>
                            <a href="/categories/node/">node</a>
                        </li>
                        
                        
                        <li>
                            <a href="/categories">...</a>
                        </li>
                        
                        
                    </ul>
                </li>
                
                
                
                
                
                <li class="dropdown">
                    <!-- TODO 添加hover dropdown效果 -->
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false" data-hover="dropdown">
                        <i class="fa fa-tags"></i>标签
                    </a>
                    <ul class="dropdown-menu">
                        
                        
                        <li>
                            <a href="/tags/habit/">habit</a>
                        </li>
                        
                        <li>
                            <a href="/tags/ES6/">ES6</a>
                        </li>
                        
                        <li>
                            <a href="/tags/Electron/">Electron</a>
                        </li>
                        
                        
                        <li>
                            <a href="/tags">...</a>
                        </li>
                        
                        
                    </ul>
                </li>
                
                
                
                
                <li class="">
                    <a href="/about">
                        <i class="fa fa-user"></i>关于我
                    </a>
                </li>
                
                
            </ul>
        </div>
    </div>
</header>
    <div id="gal-body">
        <div class="container">
            <div class="row">
                <div class="col-md-8 gal-right" id="mainstay">
                    
<article class="article well article-body" id="article">
    <div class="breadcrumb">
        <i class="fa fa-home"></i>
        <a href="JINxo-geek.github.io">JINXO</a>
        >
        <span>Tampermonkey简单脚本编写</span>
    </div>
    <!-- 大型设备详细文章 -->
    <div class="hidden-xs">
        <div class="title-article">
            <h1>
                <a href="/2018/04/28/tampermonkey脚本/">Tampermonkey简单脚本编写</a>
            </h1>
        </div>
        <div class="tag-article">
            
            <span class="label label-gal">
                <i class="fa fa-tags"></i>
                
                <a href="/tags/工具/">工具</a>, 
                
                <a href="/tags/javascript/">javascript</a>
                
            </span>
            
            <span class="label label-gal">
                <i class="fa fa-calendar"></i> 2018-04-28
            </span>
            
        </div>
    </div>
    <!-- 小型设备详细文章 -->
    <div class="visible-xs">
        <center>
            <div class="title-article">
                <h4>
                    <a href="/2018/04/28/tampermonkey脚本/">Tampermonkey简单脚本编写</a>
                </h4>
            </div>
            <p>
                <i class="fa fa-calendar"></i> 2018-04-28
            </p>
            <p>
                
                <i class="fa fa-tags"></i>
                
                <a href="/tags/工具/">工具</a>, 
                
                <a href="/tags/javascript/">javascript</a>
                
                
                
            </p>
        </center>
    </div>
    <div class="content-article">
        <p>Tampermonkey，浏览器一大神器<br><a id="more"></a></p>
<h1 id="Tampermonkey"><a href="#Tampermonkey" class="headerlink" title="Tampermonkey"></a>Tampermonkey</h1><p>Tampermonkey是浏览器的一大神器，可以在里面编写javascript脚本，配合Tampermonkey自身的语法，为所匹配的网站添加自己的功能。本教程展示微博视频下载的脚本。</p>
<h1 id="了解Tampermonkey"><a href="#了解Tampermonkey" class="headerlink" title="了解Tampermonkey"></a>了解Tampermonkey</h1><p>为浏览器安装好Tampermonkey插件后,选择添加新脚本,<br>生成脚本文件如下:</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ==UserScript==</span>
<span class="token comment" spellcheck="true">// @name         New Userscript</span>
<span class="token comment" spellcheck="true">// @namespace    http://tampermonkey.net/</span>
<span class="token comment" spellcheck="true">// @version      0.1</span>
<span class="token comment" spellcheck="true">// @description  try to take over the world!</span>
<span class="token comment" spellcheck="true">// @author       You</span>
<span class="token comment" spellcheck="true">// @match        http://blog.csdn.net/</span>
<span class="token comment" spellcheck="true">// @grant        none</span>
<span class="token comment" spellcheck="true">// ==/UserScript==</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Your code here...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在生成的代码中,@math 写的是脚本生效的网址,为了使脚本对整个网站都生效可以使用通配符,也就是<em>号<br>eg:@match        <a href="http://www.xxxx.com/" target="_blank" rel="external">http://www.xxxx.com/</a></em><br>为了方便操作页面元素,可以引用jQuery框架,添加代码</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// @require    http://code.jquery.com/jquery-1.11.0.min.js</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>之后在网页下写的脚本都将生效</p>
<h1 id="元数据块"><a href="#元数据块" class="headerlink" title="元数据块"></a>元数据块</h1><p>元数据块是描述脚本的一个用户脚本部分。它通常包含脚本名称，命名空间，描述和包含和排除规则。元数据块出现在JavaScript行注释中，可能会出现在脚本内的任何位置， 但通常靠近文件的顶部。<br>如果脚本没有声明@grant，那么Greasemonkey将自动检测脚本用了哪些API（目前自动检测的方法就是简单地看脚本中有没有出现这些API的名字，哪怕注释掉没运行的也算）</p>
<table>
<thead>
<tr>
<th><strong>键</strong></th>
<th><strong>示例</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>@name</td>
<td><a href="https://www.52pojie.cn/home.php?mod=space&amp;uid=170990" target="_blank" rel="external">@name</a>  脚本名称</td>
<td>脚本的名称。该项将显示在页面的标题以及链接内容，必填项。</td>
</tr>
<tr>
<td>@description</td>
<td>@description  脚本功能描述</td>
<td>脚本功能的描述，显示在脚本标题下面，必填项。</td>
</tr>
<tr>
<td>@namespace</td>
<td></td>
<td><a href="https://www.52pojie.cn/home.php?mod=space&amp;uid=467642" target="_blank" rel="external">@namespace</a> 及 @name 这两个属性将帮助用户脚本管理器判断是否已安  装该脚本。</td>
</tr>
<tr>
<td>@version</td>
<td>@version  0.0.1</td>
<td>脚本的版本标记将使用 Mozilla 版本格式 并显示于脚本的简介页面，必填  项。</td>
</tr>
<tr>
<td>@include@exclude@match</td>
<td>@match  <em>://www.52pojie.cn/</em></td>
<td>描述脚本将执行的页面。该列表会被分析并展示到脚本的简介页面，以及  用于脚本分类。</td>
</tr>
<tr>
<td>@require</td>
<td>@require <a href="http://cdn.bootcss.com/jquery.min.js" target="_blank" rel="external">http://cdn.bootcss.com/jquery.min.js</a></td>
<td>引用外部脚本到您的脚本</td>
</tr>
<tr>
<td>@updateURL@installURL,  @downloadURL</td>
<td></td>
<td>告知用户脚本管理器应该在哪个地址获取脚本更新。</td>
</tr>
<tr>
<td>@license</td>
<td></td>
<td>脚本所使用的许可协议名称或地址，该协议需包含用户是否允许二次分发  或修改  脚本的权利。不提供许可协议则表示用户仅允许个人使用且不得  二次分发；该协  议将在脚本的简介页面显示。</td>
</tr>
<tr>
<td>@supportURL</td>
<td></td>
<td>用户可获得该脚本技术支持的链接地址 (如：错误反馈系统、论坛、电子  邮件)，该链接将显示在脚本的反馈页面。</td>
</tr>
<tr>
<td>@contributionURL</td>
<td></td>
<td>用于捐赠脚本作者的链接，该链接将显示在脚本的反馈页面。</td>
</tr>
<tr>
<td>@contributionAmount</td>
<td></td>
<td>建议捐赠金额，请配合 @contributionURL 使用。</td>
</tr>
<tr>
<td>@compatible</td>
<td></td>
<td>标记此脚本与某个浏览器兼容，兼容性信息将显示在脚本的简介页面上。</td>
</tr>
<tr>
<td>@incompatible</td>
<td></td>
<td>标记此脚本与某个浏览器不兼容，兼容性信息将显示在脚本的简介页面  上。</td>
</tr>
</tbody>
</table>
<h1 id="编写微博视频下载教程"><a href="#编写微博视频下载教程" class="headerlink" title="编写微博视频下载教程"></a>编写微博视频下载教程</h1><p>微博的视频在video中有视频直链,可以获取video的src属性,然后在页面上添加一个下载按钮,就可以直接下载视频资源.<br>在@math后跟上<code>*://weibo.com/tv/v/*</code>,让脚本在有微博视频的地址生效.</p>
<p>@require后跟上<a href="http://cdn.bootcss.com/jquery/1.8.3/jquery.min.js" target="_blank" rel="external">http://cdn.bootcss.com/jquery/1.8.3/jquery.min.js</a> 引入jq类库</p>
<p>在自执行匿名函数中写上需要执行的脚本代码.让网址自动执行.</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步:创建一个下载弹出框与获取文件名的工具对象.</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> videoTool <span class="token operator">=</span><span class="token punctuation">{</span>
    getFileName<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> rule_start<span class="token punctuation">,</span> rule_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> start <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>rule_start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//参数首字母在url字符串中的位置.</span>
        <span class="token keyword">var</span> end <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>rule_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">//弹出下载框</span>
     download<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>videoUrl<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token string">"file content!"</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
            type<span class="token punctuation">:</span> <span class="token string">"text/plain;charset=UTF-8"</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建一个blob对象</span>
        <span class="token keyword">var</span> downloadURL <span class="token operator">=</span> window<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">creatObjectURL</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建一个URL对象</span>
        <span class="token keyword">var</span> anchor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">creatElement</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建a标签DOM元素</span>
        anchor<span class="token punctuation">.</span>href <span class="token operator">=</span> videoUrl<span class="token punctuation">;</span>
        anchor<span class="token punctuation">.</span>download <span class="token operator">=</span> name<span class="token punctuation">;</span>
        anchor<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">revokeObjctURL</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二步,生成一个下载按钮,嵌入页面中</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//调用了油猴脚本的API.与元数据块中的@grant值相对应，功能是生成一个style样式</span>
<span class="token function">GM_addStyle</span><span class="token punctuation">(</span><span class="token string">'#down_video_btn{color:#fa7d3c;}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//视频下载按钮的html代码</span>
<span class="token keyword">var</span> down_btn_html <span class="token operator">=</span> <span class="token string">'&lt;li>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;a href="javascript:void(0);" id="down_video_btn" class="S_txt2" title="视频下载">'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;span class="pos">'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;span class="line S_line1" node-type="comment_btn_text">'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;span>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;em class="W_ficon ficon_video_v2 S_ficon">i&lt;/em>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;em>视频下载&lt;/em>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">' &lt;span class="arrow">&lt;span class="W_arrow_bor W_arrow_bor_t">&lt;i class="S_line1">&lt;/i>&lt;em class="S_bg1_br">&lt;/em>&lt;/span>&lt;/span>'</span><span class="token punctuation">;</span>
down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">' &lt;/li>'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//将以上拼接的html代码插入到网页里的ul标签中</span>
<span class="token keyword">var</span> ul_tag <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"div.WB_handle>ul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ul_tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ul_tag<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">"WB_row_r3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">"WB_row_r4"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>down_btn_html<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//ul_tag DOM元素结尾加上down_btn_html 元素.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后一步</p>
<p>获取播放器(video)对象中的视频地址,并编写下载按钮的单击事件.</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//获取播放器（video）对象</span>
    <span class="token keyword">var</span> video <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"video"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> video_url <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        video_url <span class="token operator">=</span> video<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取视频链接地址</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//执行下载按钮的单击事件并调用下载函数</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#down_video_btn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>video_url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            videoTool<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>video_url<span class="token punctuation">,</span> videoTool<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span>video_url<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//download属性，只要有这个属性，点击这个链接时浏览器就不在打开链接指向的文件，而是改为下载</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完整代码</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ==UserScript==</span>
<span class="token comment" spellcheck="true">// @icon            http://weibo.com/favicon.ico</span>
<span class="token comment" spellcheck="true">// @name            微博视频下载助手</span>
<span class="token comment" spellcheck="true">// @namespace       http://weibo.com</span>
<span class="token comment" spellcheck="true">// @author          jin</span>
<span class="token comment" spellcheck="true">// @description     下载微博视频</span>
<span class="token comment" spellcheck="true">// @match           *://weibo.com/tv/v/*</span>
<span class="token comment" spellcheck="true">// @require         http://cdn.bootcss.com/jquery/1.8.3/jquery.min.js</span>
<span class="token comment" spellcheck="true">// @version         0.0.1</span>
<span class="token comment" spellcheck="true">// @grant           GM_addStyle</span>
<span class="token comment" spellcheck="true">// ==/UserScript==</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//与元数据块中的@grant值相对应，功能是生成一个style样式</span>
    <span class="token function">GM_addStyle</span><span class="token punctuation">(</span><span class="token string">'#down_video_btn{color:#fa7d3c;}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//视频下载按钮的html代码</span>
    <span class="token keyword">var</span> down_btn_html <span class="token operator">=</span> <span class="token string">'&lt;li>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;a href="javascript:void(0);" id="down_video_btn" class="S_txt2" title="视频下载">'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;span class="pos">'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;span class="line S_line1" node-type="comment_btn_text">'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;span>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;em class="W_ficon ficon_video_v2 S_ficon">i&lt;/em>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;em>视频下载&lt;/em>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">' &lt;span class="arrow">&lt;span class="W_arrow_bor W_arrow_bor_t">&lt;i class="S_line1">&lt;/i>&lt;em class="S_bg1_br">&lt;/em>&lt;/span>&lt;/span>'</span><span class="token punctuation">;</span>
    down_btn_html <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">' &lt;/li>'</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//将以上拼接的html代码插入到网页里的ul标签中</span>
    <span class="token keyword">var</span> ul_tag <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"div.WB_handle>ul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ul_tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ul_tag<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">"WB_row_r3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">"WB_row_r4"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>down_btn_html<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> videoTool <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取文件名</span>
        getFileName<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> rule_start<span class="token punctuation">,</span> rule_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> start <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>rule_start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> end <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>rule_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//弹出下载框</span>
        download<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>videoUrl<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token string">"file content!"</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                type<span class="token punctuation">:</span> <span class="token string">"text/plain;charset=UTF-8"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> downloadUrl <span class="token operator">=</span> window<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> anchor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            anchor<span class="token punctuation">.</span>href <span class="token operator">=</span> videoUrl<span class="token punctuation">;</span>
            anchor<span class="token punctuation">.</span>download <span class="token operator">=</span> name<span class="token punctuation">;</span>
            anchor<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            window<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取播放器（video）对象</span>
        <span class="token keyword">var</span> video <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"video"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> video_url <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            video_url <span class="token operator">=</span> video<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取视频链接地址</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//执行下载按钮的单击事件并调用下载函数</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#down_video_btn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>video_url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                videoTool<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>video_url<span class="token punctuation">,</span> videoTool<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span>video_url<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>
</article>


<div id="comments-template"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script>
	if(!window.commentConfig) {
      window.commentConfig = {}
      window.commentConfig.title = 'Tampermonkey简单脚本编写'
    }
</script>

                </div>
                <aside class="col-md-4 gal-left" id="sidebar">
    <!-- 此为sidebar的搜索框, 非搜索结果页面 -->
<aside id="sidebar-search">
    <div class="search hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <form class="form-inline clearfix" id="search-form" method="get"
              action="/search/index.html">
            <input type="text" name="s" class="form-control" id="searchInput" placeholder="搜索文章~">
            <button class="btn btn-danger btn-gal" type="submit">
                <i class="fa fa-search"></i>
            </button>
        </form>
    </div>
</aside>
    <aside id="sidebar-author">
    <div class="panel panel-gal" data-aos="flip-right" data-aos-duration="3000">
        <div class="panel-heading" style="text-align: center">
            <i class="fa fa-quote-left"></i>
            JINXO
            <i class="fa fa-quote-right"></i>
        </div>
        <div class="author-panel text-center">
            <img src="/imgs/avatar.jpg" width="140" height="140"
                 alt="个人头像" class="author-image">
            <p class="author-description"><p>全栈</p>
</p>
        </div>
    </div>
</aside>
    
    <aside id="sidebar-recent_comments">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-comments"></i>
            最新评论
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush"></ul>
    </div>
</aside>
    
    <!-- 要配置好leancloud才能开启此小工具 -->
    
    
    <aside id="sidebar-recent_posts">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-refresh"></i>
            近期文章
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush">
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/16/vue2/">vue</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/15/前端思维数据驱动/">数据驱动</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/13/长专注/">极其专注</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/13/大白话讲解Promise/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6/">Proxy</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6today2/">Promise对象</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6today/">Reflect</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6十/">Set 和 Map 数据结构</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/10/ES6九/">Symbol</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/10/ES6八/">对象的扩展</a>
                </span>
            </li>
            
        </ul>
    </div>
</aside>
    
    
    <aside id="sidebar-rand_posts">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-refresh"></i>
            随机文章
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush">
            
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6today/">Reflect</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6today2/">Promise对象</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/08/ES6五/">函数扩展</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/10/ES6八/">对象的扩展</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/11/ES6十/">Set 和 Map 数据结构</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2017/05/05/chrome开发者工具/">chrome</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/08/es6二/">解构赋值</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/08/es6一/">let和const</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2017/05/05/虚拟内存/">虚拟内存</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2018/05/13/长专注/">极其专注</a>
                </span>
            </li>
            
        </ul>
    </div>
</aside>
    
    
    <aside id="gal-sets">
        <div class="panel panel-gal hidden-xs" data-aos="fade-up" data-aos-duration="2000">
            <ul class="nav nav-pills pills-gal">
                <li class="">
                    <a href="/2018/04/28/tampermonkey脚本/index.html#sidebar-tags" data-toggle="tab" id="tags-tab">热门标签</a>
                </li>
                <li class="">
                    <a href="/2018/04/28/tampermonkey脚本/index.html#sidebar-friend-links" data-toggle="tab" id="friend-links-tab">友情链接</a>
                </li>
                <li class="">
                    <a href="/2018/04/28/tampermonkey脚本/index.html#sidebar-links" data-toggle="tab" id="links-tab">个人链接</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="cloud-tags tab-pane nav bs-sidenav fade" id="sidebar-tags">
    
    <a href="/tags/habit/" style="font-size: 19.35977766774902px;" class="tag-cloud-link">habit</a>
    
    <a href="/tags/ES6/" style="font-size: 17.90560357368433px;" class="tag-cloud-link">ES6</a>
    
    <a href="/tags/Electron/" style="font-size: 10.14955201941319px;" class="tag-cloud-link">Electron</a>
    
    <a href="/tags/node/" style="font-size: 8.19897266896371px;" class="tag-cloud-link">node</a>
    
    <a href="/tags/工具使用/" style="font-size: 16.505711275090434px;" class="tag-cloud-link">工具使用</a>
    
    <a href="/tags/Node/" style="font-size: 12.313513653024692px;" class="tag-cloud-link">Node</a>
    
    <a href="/tags/前端/" style="font-size: 14.945266476135789px;" class="tag-cloud-link">前端</a>
    
    <a href="/tags/工具/" style="font-size: 11.92791992566035px;" class="tag-cloud-link">工具</a>
    
    <a href="/tags/数据库/" style="font-size: 13.224322951183371px;" class="tag-cloud-link">数据库</a>
    
    <a href="/tags/javascript/" style="font-size: 18.162985472683673px;" class="tag-cloud-link">javascript</a>
    
    <a href="/tags/vue/" style="font-size: 19.502179884901302px;" class="tag-cloud-link">vue</a>
    
    <a href="/tags/算法/" style="font-size: 15.430984233188726px;" class="tag-cloud-link">算法</a>
    
    <a href="/tags/数据结构/" style="font-size: 16.167161945739878px;" class="tag-cloud-link">数据结构</a>
    
    <a href="/tags/硬件/" style="font-size: 13.741678842230865px;" class="tag-cloud-link">硬件</a>
    
</div>
                <div class="friend-links tab-pane nav bs-sidenav fade" id="sidebar-friend-links">
    
    <li>
        <a href="http://kdays.net/days/" target="_blank">KDays Forum</a>
    </li>
    
    <li>
        <a href="http://www.gal123.com/" target="_blank">绅士导航♂</a>
    </li>
    
    <li>
        <a href="http://www.moe123.com/" target="_blank">萌导航</a>
    </li>
    
</div>
                <div class="links tab-pane nav bs-sidenav fade" id="sidebar-links">
    
    <li>
        <a href="https://github.com/JINxo-geek" target="_blank">Github</a>
    </li>
    
</div>
            </div>
        </div>
    </aside>
    
</aside>
            </div>
        </div>
    </div>
    <footer id="gal-footer">
    <div class="container">
        Copyright © 2018 JINXO Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.&nbsp;Theme by <a href="https://github.com/ZEROKISEKI" target="_blank">AONOSORA</a>
    </div>
</footer>

<!-- 回到顶端 -->
<div id="gal-gotop">
    <i class="fa fa-angle-up"></i>
</div>
</body>
<script src="/js/activate-power-mode.js"></script>
<script>

    // 配置highslide
	hs.graphicsDir = '/js/highslide/graphics/'
    hs.outlineType = "rounded-white";
    hs.dimmingOpacity = 0.8;
    hs.outlineWhileAnimating = true;
    hs.showCredits = false;
    hs.captionEval = "this.thumb.alt";
    hs.numberPosition = "caption";
    hs.align = "center";
    hs.transitions = ["expand", "crossfade"];
    hs.lang.number = '共%2张图, 当前是第%1张';
    hs.addSlideshow({
      interval: 5000,
      repeat: true,
      useControls: true,
      fixedControls: "fit",
      overlayOptions: {
        opacity: 0.75,
        position: "bottom center",
        hideOnMouseOut: true
      }
    })

    // 初始化aos
    AOS.init({
      duration: 1000,
      delay: 0,
      easing: 'ease-out-back'
    });

</script>
<script>
	POWERMODE.colorful = 'true';    // make power mode colorful
	POWERMODE.shake = 'true';       // turn off shake
	// TODO 这里根据具体情况修改
	document.body.addEventListener('input', POWERMODE);
</script>
<script>
    window.slideConfig = {
      prefix: '/imgs/slide/background',
      ext: 'jpg',
      maxCount: '6'
    }
</script>
<script src="/js/hs.js"></script>
<script src="/js/blog.js"></script>



<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    if(window.commentConfig) {
      window.commentConfig.id = 'Sat Apr 28 2018 22:54:53 GMT+0800'
      window.commentConfig.owner = 'null'
      window.commentConfig.repo = 'null'
      window.commentConfig.client_id = 'null'
      window.commentConfig.client_secret = 'null'
      window.commentConfig.redirect_uri = 'null'
    } else {
      window.commentConfig = {
      	id: 'Sat Apr 28 2018 22:54:53 GMT+0800',
        owner: 'null',
        repo: 'null',
        client_id: 'null',
        client_secret: 'null',
        redirect_uri: 'null'
      }
    }
</script>
<script src="/js/comment/gitment.js"></script>

</html>